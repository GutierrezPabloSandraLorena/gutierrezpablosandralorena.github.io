var map;
function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 21.1825522, lng: -99.7062614},
          zoom: 3
        });
  }
  //lat: -34.397, lng: 150.644
	  // Your use of the YouTube API must comply with the Terms of Service:
// https://developers.google.com/youtube/terms
// Called automatically when JavaScript client library is loaded.
function onClientLoad() {
    gapi.client.load('youtube', 'v3', onYouTubeApiLoad);
}
// Called automatically when YouTube API interface is loaded (see line 9).
function onYouTubeApiLoad() {
    gapi.client.setApiKey('AIzaSyDe4GeE6Tdv4rVz3BR7dv1QC35HMsOoTJQ');
}
var nextpageL="";
var nextpageY="";
var prevpageL="";
var prevpageY="";
var markers = [];

function nextPage(){
	dir= "https://www.googleapis.com/books/v1/volumes?maxResults=10&pageToken="+nextpageL+"q=" + palabra1+"&maxResults=10&key=AIzaSyDe4GeE6Tdv4rVz3BR7dv1QC35HMsOoTJQ";
	dir2=gapi.client.youtube.search.list({
        //part: 'snippet',
        //q:query		
		part:"snippet",
			type:"video",
			q:query,
			pageToken:nextpageY,
			maxResults:"10",
			order:"viewCount",
			publishedAfter:"2015-01-01T00:00:00Z"
    });
	
	busquedaLibro(dir,dir2);
}
function prevPage(){
	dir= "https://www.googleapis.com/books/v1/volumes?maxResults=10&pageToken="+prevpageL+"q=" + palabra1+"&maxResults=10&key=AIzaSyDe4GeE6Tdv4rVz3BR7dv1QC35HMsOoTJQ";
	dir2=gapi.client.youtube.search.list({
        //part: 'snippet',
        //q:query		
		part:"snippet",
			type:"video",
			q:query,
			pageToken:prevpageY,
			maxResults:"10",
			order:"viewCount",
			publishedAfter:"2015-01-01T00:00:00Z"
    });
	
	busquedaLibro(dir,dir2);
}
function busquedaLibro(dir,dir2){
	
	markers=[];
	document.getElementById('resultados').innerHTML="";
	document.getElementById('tweet').innerHTML="";
	document.getElementById('response').innerHTML="";
	document.getElementById('map').innerHTML="";
	
	console.log(document.getElementById('query').value);
	var palabra1=document.getElementById('query').value;
	var num1=document.getElementById('num').value;
	
	console.log(palabra1);

	if(dir=="")
	{
		dir= "https://www.googleapis.com/books/v1/volumes?maxResults=10&q=" + palabra1+"&key=AIzaSyDe4GeE6Tdv4rVz3BR7dv1QC35HMsOoTJQ";
	}
	$.ajax({
		url:dir,
		dataType: "json",
		success: function(datos){
			console.log(datos)
			
			var d=document.getElementById("resultados");
			d.setAttribute("backgroundColor", "Bisque");
			//for(i=0;i<datos.items.length;i++){
				var i=0;
				while (i<num1 && i<10){
				titulo="<center><h4>"+datos.items[i].volumeInfo.title+"</h4>";
				subtitulo="<h6>"+datos.items[i].volumeInfo.subtitle+"</h6>";
				autor="<h5> Autor:"+ datos.items[i].volumeInfo.authors + "</h5>";
				//resultados.innerHTML+=titulo;
				libro='<div class="col s3">'+titulo;
				//console.log(subtitulo);
				if(datos.items[i].volumeInfo.subtitle!=""){
				//resultados.innerHTML+=subtitulo;
				libro+=subtitulo;
				}
				libro+=autor;
				//resultados.innerHTML+=autor;
				//descripcion="<p>"+datos.items[i].volumeInfo.searchInfo+"</p>";
				//resultados.innerHTML+=descripcion;
					boton="<center><a href="+datos.items[i].volumeInfo.infoLink + "><button id=imagebutton class=btn red aligning >Detalles</button></a></center>";					
					if(datos.items[i].volumeInfo.imageLinks){
						url=datos.items[i].volumeInfo.imageLinks.thumbnail;
						img="<img class=responsive-img src="+url+"></center>"
						//resultados.innerHTML+=img;
						libro+=img;
					}
					libro+=boton+"</div>";
					//resultados.innerHTML+=boton;
					resultados.innerHTML+=libro;
					i++;
			}
			if(datos.nextPageToken){
			nextpageL=datos.nextPageToken;
			console.log("nextpage: "+nextpage);
			document.getElementById("next").disabled=false;
			}
			else{document.getElementById("next").disabled=true;}
			if(datos.prevPageToken){
			prevpageL=datos.nextPageToken;
			console.log("nextpage: "+nextpage);
			document.getElementById("prev").disabled=false;
			}else{document.getElementById("prev").disabled=true;}
		},
		type: 'GET'
	});
	search(dir2);
};

// Called when the search button is clicked in the html code
function search(dir) {
    var query = document.getElementById('query').value;
	var num = document.getElementById('num').value;
    // Use the JavaScript client library to create a search.list() API call.
	var request;
    if(dir==""){
		 request = gapi.client.youtube.search.list({
        //part: 'snippet',
        //q:query		
		part:"snippet",
			type:"video",
			q:query,
			maxResults:"10",
			order:"viewCount",
			publishedAfter:"2015-01-01T00:00:00Z"
   });
	}else
		request = dir;
    // Send the request to the API server, call the onSearchResponse function when the data is returned
    request.execute(onSearchResponse);
}
// Triggered by this line: request.execute(onSearchResponse);
function onSearchResponse(response) {
	var num=document.getElementById('num').value;
	var query=document.getElementById('query').value;
   // var responseString = JSON.stringify(response, '', 2);
    //document.getElementById('response').innerHTML = responseString;
	if(response.nextPageToken && num>10){
			nextpageY=response.nextPageToken;
			console.log("nextpageY: "+nextpageY);
			document.getElementById("next").disabled=false;
			console.log("nextpageY: "+nextpageY);
	}
	else{
		document.getElementById("next").disabled=true;
		
	}
	if(response.prevPageToken&& num>10){
			prevpageY=response.nextPageToken;
			console.log("prevpageY: "+prevpageY);
			document.getElementById("prev").disabled=false;
	}else{
		document.getElementById("prev").disabled=true;
	}
	
	var results = response.result;
	var n=0;
	
            $.each(results.items, function(index, item) {
            //console.log(item);
             if(n<num){
			 localiza(item);
			 
			 }n++;
             });
	//google.maps.event.addDomListener(window,'load',showMarkers);
	if(markers.length>=1) 
	{
		showMarkers();
		}
else{
	initMap();
}	

	$.ajax({
                data:  {"query":query},
                url:   'codigo.php',
                type:  'post',
                success:  function (response) {
                        $("#datos").html(response);
                        var respuesta = JSON.parse(response);
                        console.log(respuesta);
                        mostrarTwitter(respuesta);
						
						
                }
        });
	/*var saveme=$.ajax({
		type:"POST",
		url:"codigo.php",
		data:'query='+query,
		dataType:"html"
		async:false,
		success:function(){
			alert("Ha sido ejecutada la acción");
		}
	})responseText;
	console.log(saveme);*/
	
	/*$.post("codigo.php",{"query":query},function(respuesta){console.log(respuesta);});*/
}
function localiza(item){
     var request2 = gapi.client.youtube.videos.list({
                     id: item.id.videoId,
                     part: 'snippet, recordingDetails, statistics'                                  
                      });
      request2.execute(function(response1) {    
                     console.log(response1.result);
					 console.log("items"+response1.result.items);
     var latitud; var longitud; var ub='no encontrada';
     var alto=800; var ancho=1000; //var markers = [];
 //height:800px;
	//width:1000px;	
	var num=document.getElementById('num').value;
       if(num==2){alto=600; ancho=ancho/2;}  
       if(num==3){
		   ancho=ancho/2;
	   alto=alto/2;
	   console.log(alto+""+ancho);}
		  
       if(num==4){alto=alto/2; ancho=ancho/2;}
	   if(num==5 || num==6){alto=alto/2; ancho=ancho/3;}
	   if(num==7 || num==8){alto=alto/2; ancho=ancho/4;}
      // if(num==5 || num==6 || num==7 || num==8){alto=alto/3; ancho=ancho/4;}         
       if(num==9 || num==10 || num>10){alto=alto/3; ancho=ancho/5;}
  //"snippet": 
      if(response1.result.items[0].recordingDetails){
        longitud = response1.result.items[0].recordingDetails.location.longitude; 
        latitud=response1.result.items[0].recordingDetails.location.latitude;
        ub=longitud+','+latitud;
      }
	 // <div class="video-container">  width='+ancho+'px height='+alto+'px  
	  
    ide=item.id.videoId;   
     salida='<div id="izq"class="video-container" ><iframe  width='+ancho+'px height='+alto+'px src=\"//www.youtube.com/embed/'+item.id.videoId+'\" allowfullscreen></iframe></br>CANAL: '+item.snippet.channelTitle+'<br />FECHA DE PUBLICACION: '+item.snippet.publishedAt.substr(0, 9)+'<br /> Ubicación: '+ub+' </div>';
      $("#response").append(salida);       
		if(response1.result.items[0].recordingDetails){
			console.log("item mapa"+response1.result.items[0].recordingDetails);
			console.log(response1.result.items[0].recordingDetails.location.longitude);
			longitud = response1.result.items[0].recordingDetails.location.longitude; 
			latitud=response1.result.items[0].recordingDetails.location.latitude;
			console.log(longitud);
				console.log("si");
				//initMap(latitud,longitud,ide);
				titulo=item.snippet.title;
				marcador(latitud,longitud,titulo);
		}
		//}
	
	
 });
	
}
function marcador(lat2,long2,titulo){
  console.log("si");
  var pos= {lat: lat2, lng: long2};
		console.log("pos");
		map.addListener('click', function(event) {
          addMarker(event.latLng);
        });
		addMarker(pos,titulo);
}

      // Adds a marker to the map and push to the array.
function addMarker(location,titulo) {
	console.log("location");
	var message = [titulo+' Ubicacion: '+location];
	var infowindow=new google.maps.InfoWindow();
	
    var marker = new google.maps.Marker({
          position: location,
		map: map,
	center:location,
		  title:'titulo'
    });
	
	google.maps.event.addListener(marker,'click',(function(marker){
		return function(){
			infowindow.setContent(mensaje);
			infowindow.open(map,marker);
		}
	})(marker));
	//var message = [titulo+' Ubicacion: '+location];
	//var infowindow = new google.maps.InfoWindow({
    //content: message
  //});
  //marker.addListener('click', function() {
    //infowindow.open(marker.get('map'), marker);
 // });
  
    markers.push(marker);
}


// Attaches an info window to a marker with the provided message. When the
// marker is clicked, the info window will open with the secret message.
/*function message(marker, message) {
  var infowindow = new google.maps.InfoWindow({
    content: message
  });
  marker.addListener('click', function() {
    infowindow.open(marker.get('map'), marker);
  });
  markers.push(marker);
}
*/
      // Sets the map on all markers in the array.
function setMapOnAll(map) {
	console.log("show1");
    for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
    }
}
      // Removes the markers from the map, but keeps them in the array.
function clearMarkers() {
    setMapOnAll(null);
}
      // Shows any markers currently in the array.
function showMarkers() {
	console.log("show");
    setMapOnAll(map);		
}
      // Deletes all markers in the array by removing references to them.
function deleteMarkers() {
    clearMarkers();
    markers = [];
}

function mostrarTwitter(response){
console.log(response);
console.log("si mostrar "+response.statuses.length);

/*$.each(response, function (index, tweet) {
						$tweets = $('.tweet').first().clone();

						$tweets.find('.img').attr('src',tweet.statuses[i].user.profile_background_image_url);
						$tweets.find('.name').text(tweet.statuses[i].user.screen_name);
						$tweets.find('.username').html("<a target='blank_' href='http://twitter.com/"+tweet.screen_name+"'>"+tweet.screen_name+"</a>");
						$tweets.find('.date').text((tweet.statuses[i].user.created_at).substring(0, (tweet.statuses[i].user.created_at).length - 5));
						$tweets.find('.text').text(tweet.statuses[i].text);

						
						//url_imagen=response.statuses[i].user.profile_background_image_url;
			/*screen_name =response.statuses[i].user.screen_name;
			
			fecha = "<center><h4>"+response.statuses[i].user.created_at+"</h4>";
			texto ="<center><h4>"+response.statuses[i].text+"</h4>";
			name = "<a href='https://twitter.com/"+screen_name+"' target=_blank>@"+screen_name+"</a>";
			
			imagen ="<center><h4>"+name+" <a href='https://twitter.com/"+screen_name+"' target=_blank><img width='30px' height='30px' src="+url_imagen+"></img></a></h4>";
            console.log("texto"+texto);
						
						$tweets.hide().appendTo('#tweets').fadeIn();

					})*/
for (var i = 0; i <=response.statuses.length; i++) {
	console.log("si for");
 // var texto = '<img style="width:30px; height: 30px" src= "'+ response.statuses[i].user.profile_background_image_url + '"class="circle">' + response.statuses[i].text
  //var a=document.getElementById("tweet");
  //texto.appendTo("a");
  
  
  var t=document.getElementById("tweet");
			t.setAttribute("backgroundColor", "Bisque");
			
			//imagen = '<img style="width:30px; height: 30px" src= "'+ response.statuses[i].user.profile_background_image_url;
			
			url_imagen=response.statuses[i].user.profile_background_image_url;
			screen_name =response.statuses[i].user.screen_name;
			
			fecha = "<center><h4>"+response.statuses[i].user.created_at+"</h4>";
			texto ="<center><h4>"+response.statuses[i].text+"</h4>";
			name = "<a href='https://twitter.com/"+screen_name+"' target=_blank>@"+screen_name+"</a>";
			
			imagen ="<center><h4>"+name+" <a href='https://twitter.com/"+screen_name+"' target=_blank><img width='50px' height='50px' src="+url_imagen+"></img></a></h4>";
            console.log("texto"+texto);
			 tt='<div id="tw" class="container col s6 l12">'+fecha+''+imagen+'name'+name+''+texto+'</div>';
			
			tweetagregar="<div class=tweet><img class=img src="+response.statuses[i].user.profile_background_image_url+"/><div class=info><p class=user>"+name+"<span class=name></span><span class=username>"+response.statuses[i].user.screen_name+"</span>"+
					"<span class=date>"+response.statuses[i].user.created_at+"</span>"+
				"</p><p class=text>"+response.statuses[i].text+"</p></div></div>";
			//$user->user->profile_image_url;
			//for(i=0;i<datos.items.length;i++){
				//var i=0;
				//while (i<num1 && i<10){
					//var texto = '<img style="width:30px; height: 30px" src= "'+ response.statuses[i].user.profile_background_image_url + '"class="circle">' + response.statuses[i].text
  
				/*titulo="<center><h4>"+datos.items[i].volumeInfo.title+"</h4>";
				subtitulo="<h6>"+datos.items[i].volumeInfo.subtitle+"</h6>";
				autor="<h5> Autor:"+ datos.items[i].volumeInfo.authors + "</h5>";*/
				
				/*tweet.innerHTML+=fecha;
				tweet.innerHTML+=imagen;
				tweet.innerHTML+=name;
				tweet.innerHTML+=texto;
				*/
				tweet.innerHTML+=tt;
				//tweet1.innerHTML+=tweetagregar;
				//console.log(subtitulo);
				/*if(datos.items[i].volumeInfo.subtitle!=""){
				resultados.innerHTML+=subtitulo;
				}
				resultados.innerHTML+=autor;
				//descripcion="<p>"+datos.items[i].volumeInfo.searchInfo+"</p>";
				//resultados.innerHTML+=descripcion;
					boton="<a href="+datos.items[i].volumeInfo.infoLink + "><button id=imagebutton class=btn red aligning>Detalles</button></a>";					
					if(datos.items[i].volumeInfo.imageLinks){
						url=datos.items[i].volumeInfo.imageLinks.thumbnail;
						img="<img src="+url+"></center>"
						resultados.innerHTML+=img;
					}
					resultados.innerHTML+=boton;*/
					//i++;
			//}
						
						//$('a').attr('current',$('input').val());
					/*$fecha = $user->created_at;
            $url_imagen = $user->user->profile_image_url;
            $screen_name = $user->user->screen_name;
            $tweet = $user->text;

            $imagen = "<a href='https://twitter.com/".$screen_name."' target=_blank><img src=".$url_imagen."></img></a>";
            $name = "<a href='https://twitter.com/".$screen_name."' target=_blank>@".$screen_name."</a>";
	*/
						
  
  
  if(response.statuses[i].geo !== undefined && response.statuses[i].geo !== null){
    if(response.statuses[i].geo.coordinates){
       console.log(response.statuses[i].geo.coordinates);
       marcadorTwitter(response.statuses[i].geo.coordinates[0],response.statuses[i].geo.coordinates[1], texto,"https://icon-icons.com/icons2/730/PNG/32/twitter_icon-icons.com_62765.png");
      }else{
    console.log("No tiene");
      }
    }else
    console.log("No tiene");
  }
}
showMarkers();
}
function marcadorTwitter(lat2,long2,titulo,imagen){
  console.log("si");
  var pos= {lat: lat2, lng: long2};
		console.log("pos");
		map.addListener('click', function(event) {
          addMarker(event.latLng);
        });
		addMarker(pos,titulo,imagen);
}

      // Adds a marker to the map and push to the array.
function addMarkerTwitter(location,titulo,imagen) {
	console.log("location");
	var message = titulo+" Ubicacion: "+location+"<img src="+imagen+"/>";
	var infowindow=new google.maps.InfoWindow();
	
    var marker = new google.maps.Marker({
          position: location,
		map: map,
	center:location,
		  title:'titulo'
		  /*icon:{
			  path:google.maps.SymbolPath.CIRCLE,
			  scale:10,
			  strokeColor:'#f00',
			  strokeWeight:5,
			  fillColor: '#00f',
			  fillOpacity:1<!DOCTYPE html>
<html>
    <head>
        <script src="js/search.js" type="text/javascript"></script>     
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script> 
        <script src="https://apis.google.com/js/client.js?onload=onClientLoad" type="text/javascript"></script>
		<meta charset="utf-8">
		<link rel="stylesheet" href="css/estilo.css">
		<link rel="stylesheet" href="css/materialize/css/materialize.min.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/Dogfalo/materialize/fc44c862/dist/css/materialize.min.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <script src="https://cdn.rawgit.com/Dogfalo/materialize/fc44c862/dist/js/materialize.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/pinzon1992/materialize_table_pagination/f9a8478f/js/pagination.js"></script>
		<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/flat-ui.css">
	
		<title>MASHUP</title>
    </head>
    <body>
	<!--<div class="container" style="text-align: center">	
	<div class="row">
	 <div class="col s6 l12" >
			<div class="search" style="text-align: center"> 
				<h3>BÚSQUEDA DE LIBROS/VIDEOS/MAPA </br>BOOKS+YOUTUBE+MAPS API GOOGLE<h3>
				
			 <!--<div id="busqueda" class="#f5f5f5 grey lighten-4 z-depth-5">
			<input id="query" placeholder="Ingresa palabra a buscar" class="input-field col s6 l12" value="" type="text" required/>
			<input id="num" value="" class="input-field col s6 l12" placeholder="Número de resultados" required type="number"/>
			<button id="boton" type="button" class="btn waves-effect waves-light purple" onclick="busquedaLibro('','')">Search</button>
			<!--</div>
			</div>
		</div>
		</div>
		</div>
		-->
		<div class="input-field col s3 m12 l12">
		<center>
		<h3>BÚSQUEDA DE LIBROS/VIDEOS/MAPA </br>BOOKS+YOUTUBE+MAPS API GOOGLE<h3>
		<div id="busqueda" class="#f5f5f5 grey lighten-4 z-depth-5 col s3 m12 l12">
        <input id="query" placeholder="Ingresa palabra a buscar" class="input-field" value="" type="text" required/>
		<input id="num" value="" class="input-field" placeholder="Número de resultados" required type="number"/>
        </div>
		<button id="boton" type="button" class="btn purple" onclick="busquedaLibro('','')">Search</button>
		</center>
		</div>
<!--<div class="col s6 l12" >
				</div>-->
		<div class="input-field col s3 m12 l12">
		 <div class="container col s12 m6 l3" >
		  <div id="izq">
		  <div class="row" id="resultados">
				 
			</div>
			
		</div>
		</div>
		<div id="izq" class="input-field col s3 m12 l12">
		<div class="container" id="response">
		</div>
        
		</div>
		<center>
		<button id="prev" type="button" class="btn purple" onclick="prevPage()" disabled>Anterior</button>
		<button id="next" type="button" class="btn purple" onclick="nextPage()" disabled>Siguiente</button>
		</center>
		
		
    <div class="container col s6 l12" id="map"></div>
		
		<div class="container col s6 l12" >
			<div class="row" id="tweet">
		</div>
		</div>
		<div id="tweet1">
		</div>
	
		
		<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
		
		<script src="https://apis.google.com/js/client.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDe4GeE6Tdv4rVz3BR7dv1QC35HMsOoTJQ&callback=initMap"
    async defer></script>
    </body>
	
</html>

		  }*/
    });
	
	google.maps.event.addListener(marker,'click',(function(marker){
		return function(){
			infowindow.setContent(mensaje);
			infowindow.open(map,marker);
		}
	})(marker));
	//var message = [titulo+' Ubicacion: '+location];
	//var infowindow = new google.maps.InfoWindow({
    //content: message
  //});
  //marker.addListener('click', function() {
    //infowindow.open(marker.get('map'), marker);
 // });
  
    markers.push(marker);
}



